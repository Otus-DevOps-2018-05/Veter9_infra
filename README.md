# Veter9_infra
Veter9 Infra repository

Первые 6 домашек без какого-либо описания, потому что тупанул. 
Сейчас уже не буду добавлять ибо лень. 


## Выполнение самостоятельного домашнего задания 7.

Домашнее задание Terraform-2

- Сделал импорт существующей инфраструктуры
- Разбил на модули terraform
- Добавил переменные глобальные модулей
- Добавил значение атрибутов с других ресурсов
- Проверена работа  зависимостей
- Новый модуль vpс добавил
- Добавил директории stage и prod и туда перенес все конфиги
- Почистил корень проекта терраформ, разнес все по директориям
- Параметризированы необходимые переменные
- Конфигурационные файлы имеют форматирование согласно terraform fmt

## Выполнение ДЗ 8 ansible-1
- Создал новый бранч ansible
- Добавил новую директорию и файлом requirements.txt
- установил python-pip пакет
- установил ansible через pip
- вернулся в директорию stage и поднял виртуалку на gcp
- создал новый файл inventory в ansible
- пинганул созданный хост через модуль ансибл
- пинганул вторй сервер db, не забыв добавить его параметры второй строчкой в инвентор
- создал файла конфига ансибла ansible.cfg и заполнил его
- убрал лишнее из инвентори
- разделил хосты по группам
- поигрался с модулями(вне дз)
- сделал первый коммит
- поигрался с модулями в рамках слайдов практики
- удивился и обрадовался как это здорово, что есть готовые модули,уркал пару идей для своей работы
- создал файл clone.yml и залил конфиг для плейбука
- По заданию на слайде 29: я так понял копирование с клона было, а перезаливка в директорию не было.
- по ошибке все пульнул в бранч ансибл-2
- переделал и пульнул все в ансибл-1

## Выполнение ДЗ 9 ansible-2
- чекаутнулся на бранч ansible-2 (он уже был создан по ошибке в предыжущем дз)
- создал папку templates, в ней создал файл конфигурации mongod.conf.j2 (l;byl;f&)
- создал плейбук reddit_app.yml
- обновил гитигнор
- добавил модуль template в ямл файл и указал тэг
- добавил директорию templates, куда закинул новый файл шаблона джинджи
- прочекал плейбук в консоли
- предыдущий шаг был с ошибкой. добавил переменные mongo_bind_ip в плейбук
- прочекал ещё раз - всё отлично
- в плейбук добавляем хэндлер для рестарта монги
- снова всё чекаем(хорошая практика)
- первый коммит (слайд 24)
- создал директорию files 
- добавил внутрь новый файл puma.service
- добавил новое задание в reddit_app.yml для копирование файла на хост 
- добавил ещё один хэндлер
- добавил новый шаблон db_config.j2 в папку templates
- добавил новый таск для копирования нового шаблона
- объявил переменную. IP internal на слайде совпал с моим internal IP GCP
- запустил первый чек -всё ок
- применил таски на реальной машине gcp 
- переходим к деплою (заметка для себя)
- сделал второй коммит (слайд 35)
- добавил в reddit_app.yml fetch lastest reddit
- сделал чек и прогон плейбука (всё ок)
- создал новый файл reddit_app2.yml
- перенёс туда всё для mongod
- убил все машины терраформом и пересоздал их
- проверил ансибл-плейбук
- не понравилось формирование инвентори руками снова, решил погуглить как это мождно автоматизировать
- начал мучатся с динамическими инвентори.......
......
- 3 часа впустую. не разобрался =( 
- сделал всё через баш, добавил новый скрипт, который грепает адреса инстансов
```bash
#!/usr/bin/env bash
path="/home/nedoumenie/Desktop/Veter9_infra/ansible"
echo "[app]" > $path/inventory
echo "appserver ansible_host="`gcloud compute instances list | awk 'NR==2' | awk '{print $5}'` >> $path/inventory
path="/home/nedoumenie/Desktop/Veter9_infra/ansible"
echo "[db]" >> $path/inventory
echo "appserver ansible_host="`gcloud compute instances list | awk 'NR==3' | awk '{print $5}'` >> $path/inventory
```
- добавил в reddit_app2.yml деплой пумы
- создал три новых файла app.yml db.yml deploy.yml
- переименовал reddit_app.yml и reddit_app2.yml в другие имена, по слайду
- сделал третий коммит, слайд 56
- заполнил эти три новых файла
- добавил новый файл site.yml, куда импортнул три предыдщуих файла
- прочекал всё. вроде ок.
- чевертый коммит.
- добавил новые файлы для провижининга


после выполнения дз ирерахия директорий выглядит так:
```
ansible
├──files
|  └── puma.service
├──templates
|  ├── db_config.j2
|  └── mongod.conf.j2
├── requirements.txt
├── site.yml
├── reddit_app_multiple_plays.yml
├── reddit_app_one_play.yml
├── inventory
├── inventory.yml
├── fillinventory.yml
├── deploy.yml
├── db.yml
├── app.yml
├── ansible.cfg
├── packer_app.yml
├── packer_db.yml
└── clone.yml
```

## Выполнение ДЗ 10 ansible-3
- создал новый бранч ansible-3 и сделал чекаут
- добавил новую папку roles
- командой ansible-galaxy init db/app сделал новую структуру
- поработал над переносом тасков. описывать всё не буду - по слайдам все делал.
- все эти подготовки сделал ровно до слайда 24. затем первый коммит
- на 25 слайде увидел ошибку бандл инсталлера, но забил хер на это
- добавил новую папку environments и в ней две директории prod и stage
- скопировал туда инвентори(до сих пор не динамический)
- удалил инвентори с корня ансибл директории
- в дефолтном конфиге ансибла поставил инвентори от стейджа
- добавил папки group_vars для стейджа и прода. переместил туда переменные из app.yml db.yml
- почистил от переменных app.yml db.yml
- создал новый файл all в стейдже и прода environments
- сделал коммит(слайд 38))
- определяю переменную по умолчанию в env
- добавляем новые роли
- добавляю директорию playbooks и переношу туда все нужное
- добавляю папку old для архива
- перенёс весь олд в олд :D
- переместил все файлы/директории, как на слайде 46
- сделал коммит
- улучшаем ансибл конфиг
- пересоздал машинки gcp, прочекал плейбуки
- добавил непонятный файл непонятой роли в гитигнор
- заинсталлил эту роль
- добавил проксирование порта
- работа с ansible vault. Создал файл users.yml , vault.key , credentials.yml 
- сделал коммит перед шифрованием
- зашифровал файлы, всё ок

## Выполнение ДЗ 11 ansible-4
- создал бранч и сделал чекаут
- добавил новые расширения в гитигнор
- установил вагрант и виртуалбокс(нет, они у меня были уже)
- добавил провиженеры
- добавил base.yml вместе с инклюдом в site.yml
- коммит, слайд 20. голова уже не варит, продолжу завтра.
- добавил две новые роли: для инсталла монги и её конфига
- добавил в main.yml инклюды новых ролей
- добавил две новые роли для руби в апп директории
- поправил вагрант файл
- много что сделал до слайда 41. роли всякие поправил
- удалил и поднял варант для проверки всех конфигов
- установил зависимости 
- проверил молекулу - все ок
- добавил новые тесты молекулы(пришлось через консоль, пайчарм не мог в read only пролезть)
- создал VM для проверки роли
- протестировал роли (57 слайд)
- поправил плейбук молекулы (слайд 58)
- сделал коммит
- применил конфигурацию
- прогнал тесты
- протупил на задании слайда 62
- изменил владельца папки molecule
- ещё раз поправил все права..
- повесил чмод 777


